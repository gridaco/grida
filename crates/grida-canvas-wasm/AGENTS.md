# `@grida/canvas-wasm`

> Grida Canvas WASM bindings.
> This crate/package contains both Cargo.toml and package.json for binding, building and publishing as a npm package.

Uses emscripten to build the WASM module.

emscripten artifacts `grida-canvas-wasm.js` and `grida-canvas-wasm.wasm`
as new apis are introduced via `main.rs`, we also need to update the `grida-canvas-wasm.d.ts` file.

Note: the artifacts are git included for faster CI builds.

## Build System

This project uses a unified `justfile` build system for all WASM build configurations.

### Quick Commands

```bash
# Show available commands
just

# Development build (debug mode)
just dev

# Production build (optimized)
just build

# Clean and build
just clean && just build
```

### Build Configurations

| Command      | Description                    | Output     | File Size |
| ------------ | ------------------------------ | ---------- | --------- |
| `just dev`   | Development build (debug mode) | `debug/`   | ~100MB    |
| `just build` | Production build (optimized)   | `release/` | ~10MB     |
| `just clean` | Clean all build artifacts      | -          | -         |
| `just info`  | Show build information         | -          | -         |

### Build Types

#### Development Build (`just dev`)

- **Purpose**: General development and testing
- **Features**: Basic WebGL2 support, no debugging features
- **Use Case**: Quick testing, basic functionality verification

#### Production Build (`just build`)

- **Purpose**: Optimized production deployment
- **Features**: Release mode, O3 optimization, aggressive variable elimination
- **Use Case**: Production deployment, performance-critical applications

## Prerequisites

- **Emscripten SDK**: Required for building WebAssembly modules
- **Rust**: Latest stable version
- **Git**: For submodule management
- **Just**: Command runner (install with `cargo install just` or `brew install just`)

## Output Files

The build produces:

- **`grida_canvas_wasm.wasm`**: The main WebAssembly module
- **`grida-canvas-wasm.js`**: JavaScript bindings automatically generated by Emscripten
- **Source maps**: For debugging (in debug builds)

### Output Locations

- **Development**: `../../target/wasm32-unknown-emscripten/debug/grida_canvas_wasm.wasm`
- **Production**: `../../target/wasm32-unknown-emscripten/release/grida_canvas_wasm.wasm`

## Features

The WASM build includes:

- ✅ **Skia Graphics Library**: High-performance 2D graphics
- ✅ **WebGL2 Support**: Hardware-accelerated rendering
- ✅ **Font Parsing**: Full TTF/OTF font support
- ✅ **Vector Graphics**: SVG and custom vector rendering
- ✅ **Text Layout**: Advanced text rendering and layout
- ✅ **Export Capabilities**: PNG, PDF, SVG export

## Usage in Web Applications

The generated WASM module exports C functions that can be called from JavaScript:

```javascript
// Initialize the canvas
const app = Module._init(width, height, useEmbeddedFonts);

// Load a scene
Module._load_scene_json(app, sceneJsonPtr, sceneJsonLen);

// Render a frame
Module._tick(app, timestamp);

// Handle user input
Module._pointer_move(app, x, y);
```

## Manual Build

If you prefer to build manually:

### Debug Build

```bash
# Activate Emscripten environment
source ../../third_party/externals/emsdk/emsdk_env.sh

# Set environment variables
export CC=emcc
export CXX=em++
export AR=emar

# Build
cargo build --target wasm32-unknown-emscripten
```

### Production Build

```bash
# Activate Emscripten environment
source ../../third_party/externals/emsdk/emsdk_env.sh

# Set environment variables for production
export CC=emcc
export CXX=em++
export AR=emar

# Build with release optimizations
cargo build --release --target wasm32-unknown-emscripten
```

## Troubleshooting

### Common Issues

1. **"just: command not found"**

   - Install just: `cargo install just` or `brew install just`

2. **"emcc: command not found"**

   - Ensure Emscripten SDK is installed and activated
   - Run `source ../../third_party/externals/emsdk/emsdk_env.sh`

3. **"xlocale.h file not found"**

   - This should be automatically fixed by the build scripts
   - If it persists, check that the emsdk submodule is properly initialized

4. **Large file size**
   - The WASM file is ~100MB due to Skia graphics engine
   - Use `just dev` for development (includes debugging info)
   - Use `just build` (release version) for ~10MB optimized size

### Performance Tips

- Use WebGL2-enabled browsers for best performance
- Enable hardware acceleration in browser settings
- Consider using Web Workers for heavy graphics operations
- Use the development build for debugging, production build for deployment

## Development

For development and testing:

1. Use `just dev` for debugging features
2. Enable browser developer tools for WASM debugging
3. Use source maps for better error tracking
4. Test in multiple browsers (Chrome, Firefox, Safari)

## Production

For production deployment:

1. Use optimized builds (release mode)
2. Consider code splitting for large applications
3. Implement proper error handling for WASM loading
4. Test performance on target devices

## Advantages of Justfile

1. **Unified Interface**: Single command system for all build types
2. **Better Organization**: Clear separation of concerns with internal recipes
3. **Dependency Management**: Automatic dependency checking and environment setup
4. **Consistent Output**: Standardized success messages and error handling
5. **Extensibility**: Easy to add new build configurations or commands

## Troubleshooting / Building WASM locally (vanilla way)

> follow this if you can't use justfile or os-specific trouble shooting.

The WASM build targets `wasm32-unknown-emscripten` and requires the Emscripten SDK.
The steps below were tested on a fresh Ubuntu container and produced
`lib/bin/grida_canvas_wasm.wasm` and `lib/bin/grida-canvas-wasm.js`.

1. **Fetch submodules and install build tools**

   ```bash
   git submodule update --init --recursive
   rustup target add wasm32-unknown-emscripten
   pnpm install
   ```

2. **Install and activate Emscripten**

   ```bash
   cd third_party/externals/emsdk
   ./emsdk install latest
   ./emsdk activate latest
   cd -
   ```

3. **(Ubuntu only) provide missing locale headers**
   Some Ubuntu images lack `xlocale.h` which breaks the Skia build. A simple symbolic link fixes it:

   ```bash
   sudo ln -s /usr/include/locale.h /usr/include/xlocale.h
   ```

4. **Build the crate**

   ```bash
   cd crates/grida-canvas-wasm
   source ../../third_party/externals/emsdk/emsdk_env.sh
   export CC=emcc CXX=em++ AR=emar
   cargo build --release --target wasm32-unknown-emscripten
   ```

5. **Copy artifacts and package**
   ```bash
   mkdir -p lib/bin
   cp ../../target/wasm32-unknown-emscripten/release/*.js lib/bin/
   cp ../../target/wasm32-unknown-emscripten/release/*.wasm lib/bin/
   pnpm --filter @grida/canvas-wasm build
   ```

After these steps the compiled module is ready in `lib/bin/` for consumption or publishing.
