# Grida Canvas WASM Build System
# Unified build system for all WASM build configurations

# Shared snippet used by debug/release builds.
# Keep this inline (vs. a separate recipe) so the sourced `emsdk_env.sh` affects the same shell.
_wasm32_unknown_emscripten_env := "rustup target add wasm32-unknown-emscripten; (cd ../.. && ./bin/activate-emsdk); . ../../third_party/externals/emsdk/emsdk_env.sh; command -v emcc >/dev/null 2>&1; export CC=emcc CXX=em++ AR=emar"

# Default recipe - shows available commands
default:
    @echo "ğŸš€ Grida Canvas WASM Build System"
    @echo ""
    @echo "Available commands:"
    @echo "  just dev                - Development build (debug mode + copy + package)"
    @echo "  just build              - Production build (optimized + copy + package)"
    @echo "  just package            - Build package with pnpm"
    @echo "  just clean              - Clean all build artifacts"
    @echo "  just info               - Show build information"
    @echo ""
    @echo "Examples:"
    @echo "  just build                         # Production build (includes copy & package)"
    @echo "  just dev                           # Development build (includes copy & package)"
    @echo "  just clean && just build           # Clean and production build"

# Development build (debug mode)
dev:
    @just _build_wasm32_unknown_emscripten_debug
    @echo "ğŸ“ Copying debug WASM artifacts to lib/bin..."
    @mkdir -p lib/bin
    @cp ../../target/wasm32-unknown-emscripten/debug/*.js lib/bin/ 2>/dev/null || echo "No .js files found in debug"
    @cp ../../target/wasm32-unknown-emscripten/debug/*.wasm lib/bin/ 2>/dev/null || echo "No .wasm files found in debug"
    @echo "âœ… Debug artifacts copied to lib/bin/"
    @just package

# Production build (optimized release)
build:
    @just _build_wasm32_unknown_emscripten_release
    @echo "ğŸ“ Copying release WASM artifacts to lib/bin..."
    @mkdir -p lib/bin
    @cp ../../target/wasm32-unknown-emscripten/release/*.js lib/bin/ 2>/dev/null || echo "No .js files found in release"
    @cp ../../target/wasm32-unknown-emscripten/release/*.wasm lib/bin/ 2>/dev/null || echo "No .wasm files found in release"
    @echo "âœ… Release artifacts copied to lib/bin/"
    @just package

# Clean build artifacts
clean:
    @echo "ğŸ§¹ Cleaning build artifacts..."
    cargo clean
    @echo "âœ… Clean completed!"


# Build package with pnpm
package:
    @echo "ğŸ“¦ Building package with pnpm..."
    @pnpm --filter @grida/canvas-wasm build
    @echo "âœ… Package build completed!"


# Show build information
info:
    @echo "ğŸ“Š Grida Canvas WASM Build Information"
    @echo ""
    @echo "Build Scripts:"
    @echo "  Development: just dev             (~100MB, debug mode)"
    @echo "  Production:  just build           (~10MB, optimized)"
    @echo ""
    @echo "Output Locations:"
    @echo "  Development: ../../target/wasm32-unknown-emscripten/debug/deps/grida_canvas_wasm.wasm"
    @echo "  Production: ../../target/wasm32-unknown-emscripten/release/deps/grida_canvas_wasm.wasm"
    @echo ""
    @echo "Environment Requirements:"
    @echo "  - Emscripten SDK (emsdk)"
    @echo "  - Rust (latest stable)"
    @echo "  - Git (for submodules)"
    @echo ""
    @echo "Configuration:"
    @echo "  - Linker arguments configured in .cargo/config.toml"
    @echo "  - ERROR_ON_UNDEFINED_SYMBOLS=0 (allow undefined symbols)"
    @echo "  - ENVIRONMENT=web,node (web + node environments)"
    @echo "  - MAX_WEBGL_VERSION=2 (WebGL2 support)"
    @echo "  - ALLOW_MEMORY_GROWTH=1 (dynamic memory growth)"
    @echo "  - MODULARIZE=1 (modular output)"
    @echo "  - EXPORT_NAME=createGridaCanvas (export function name)"
    @echo "  - EXPORTED_RUNTIME_METHODS (GL, UTF8, HEAP functions)"

# Internal recipe: Build WASM (debug mode)
_build_wasm32_unknown_emscripten_debug:
    @echo "ğŸ”¨ Building for wasm32-unknown-emscripten target..."
    @bash -c 'set -euo pipefail; \
        {{_wasm32_unknown_emscripten_env}}; \
        echo "ğŸ§° $(emcc --version | { IFS= read -r l; echo "$l"; })"; \
        time cargo build --target wasm32-unknown-emscripten'
    @echo "âœ… Build completed successfully!"
    @echo "ğŸ“ Output file: ../../target/wasm32-unknown-emscripten/debug/grida_canvas_wasm.wasm"
    @echo "ğŸ‰ Grida Canvas WASM is ready for use!"

# Internal recipe: Build WASM (release mode)
_build_wasm32_unknown_emscripten_release:
    @echo "ğŸ”¨ Building for wasm32-unknown-emscripten target (Production Mode)..."
    @bash -c 'set -euo pipefail; \
        {{_wasm32_unknown_emscripten_env}}; \
        echo "ğŸ§° $(emcc --version | { IFS= read -r l; echo "$l"; })"; \
        time cargo build --release --target wasm32-unknown-emscripten'
    @echo "âœ… Production build completed successfully!"
    @echo "ğŸ“ Output file: ../../target/wasm32-unknown-emscripten/release/grida_canvas_wasm.wasm"
    @echo "âš¡ Production optimizations applied:"
    @echo "   - Release mode compilation"
    @echo "   - O3 optimization level"
    @echo "   - Aggressive variable elimination"
    @echo "   - No debugging symbols"
    @echo "ğŸ‰ Grida Canvas WASM (Production) is ready!"
    @echo "ğŸ’¡ This build is optimized for production use"
    @echo "ğŸš€ Use this for deployment and production applications"