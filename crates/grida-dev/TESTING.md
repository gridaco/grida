# SVG Reftest Testing

The `reftest` command in `grida-dev` provides a testing framework for evaluating SVG rendering accuracy by comparing rendered outputs against reference images from the W3C SVG 1.1 Test Suite.

## Overview

The reftest system:

- Renders SVG files from the W3C test suite to PNG
- Compares rendered outputs with reference PNG images
- Calculates similarity scores (0.0 to 1.0) and difference percentages
- Generates comprehensive JSON reports with metrics
- Optionally creates visual diff images using external tools

This is a **scoring system**, not a pass/fail assertion framework. It provides metrics to evaluate the current state of SVG rendering implementation.

## Prerequisites

- W3C SVG 1.1 Test Suite directory with:
  - `svg/` directory containing SVG test files
  - `png/` directory containing reference PNG images
- (Optional) External diff tool for generating visual diff images:
  - `perceptualdiff`
  - ImageMagick `compare`

## Usage

### Basic Usage

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite
```

This will:

- Discover all SVG/PNG test pairs
- Render each SVG to PNG
- Compare with reference images
- Generate a `report.json` in the current directory

### With Output Directory

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results
```

Output files will be saved to the specified directory, organized by score categories:

- `{test-name}.expected.png` - Reference PNG from test suite
- `{test-name}.current.png` - Our rendered version
- `{test-name}.diff.png` - Visual difference image (generated by dify)
- `report.json` - Comprehensive test report

### Filtering Tests

Run only specific test categories:

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results \
  --filter "shapes-*"
```

The filter uses simple pattern matching. Examples:

- `--filter "shapes-*"` - All shape tests
- `--filter "paths-*"` - All path tests
- `--filter "gradient"` - Tests containing "gradient" in name

### With Diff Tool

Generate visual diff images using an external tool:

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results \
  --diff-tool /usr/local/bin/perceptualdiff
```

Or use ImageMagick's compare:

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results \
  --diff-tool compare
```

## Command-Line Options

| Option                | Required | Description                                             |
| --------------------- | -------- | ------------------------------------------------------- |
| `--suite-dir <path>`  | Yes      | Path to W3C_SVG_11_TestSuite directory                  |
| `--output-dir <path>` | No       | Directory for output files (default: current directory) |
| `--filter <pattern>`  | No       | Filter test files by pattern (e.g., "shapes-\*")        |
| `--diff-tool <path>`  | No       | Path to external diff tool for generating diff.png      |

## Output Directory

- Default: `target/reftests`
- Use `--output-dir <path>` to override.
- The directory is cleared on each run unless `--no-overwrite` is provided.

## Output Structure

For each test, the following files are generated:

- a.png – actual/current rendering (our output)
- b.png – expected/reference image (from the suite)
- d.png – diff image (visual differences)
- report.json – summary report at the root of the output directory

> Important
>
> - The diff comparer composites images over a solid background before pixel diffing.
> - Default background is `black` (equivalent to `--bg black`). For most SVG test suites where text is black, running with a white background improves text-edge sensitivity and reduces false negatives.
> - Recommendation: use `--bg white` for SVG tests unless a specific test suite requires another color.
>
> Example:
>
> ```bash
> cargo run -p grida-dev -- reftest \
>   --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
>   --output-dir test-results \
>   --threshold 0 \
>   --bg white
> ```

### Report Fields

- total: Total number of tests executed
- average_similarity: Average similarity score across all tests (0.0-1.0)
- min_similarity: Lowest similarity score found
- max_similarity: Highest similarity score found
- timestamp: Unix timestamp when report was generated
- suite_dir: Path to the test suite directory
- output_dir: Path to the output directory
- tests: Array of individual test results

### Test Result Fields

- test_name: Name of the test (without extension)
- similarity_score: Similarity score from 0.0 (completely different) to 1.0 (identical)
- diff_percentage: Percentage of pixels that differ (0.0-100.0)
- output_png: Path to a.png (actual)
- diff_png: Path to d.png (null if not generated)
- error: Error message if test failed (null if successful)

### Interpreting Scores

- **similarity_score = 1.0**: Perfect match (identical rendering)
- **similarity_score > 0.9**: Very close match (minor differences)
- **similarity_score > 0.7**: Good match (some differences)
- **similarity_score > 0.5**: Moderate match (significant differences)
- **similarity_score < 0.5**: Poor match (major differences)
- **similarity_score = 0.0**: Complete mismatch or error

## Examples

### Run All Tests

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results
```

### Test Only Shape Rendering

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results \
  --filter "shapes-*"
```

### Test with Visual Diffs

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results \
  --diff-tool compare
```

### Quick Test of Specific Category

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir quick-test \
  --filter "paths-data-*"
```

## Tips

1. **Start with filtered tests**: Use `--filter` to test specific categories first
2. **Check diff images**: Use `--diff-tool` to visually inspect differences
3. **Review low scores**: Focus on tests with `similarity_score < 0.7` for improvement
4. **Compare over time**: Run tests regularly to track rendering improvements
5. **Use output directory**: Keep test results organized in a dedicated directory

## Troubleshooting

### "SVG directory not found" or "PNG directory not found"

- Ensure the `--suite-dir` points to the correct W3C test suite directory
- Verify that `svg/` and `png/` subdirectories exist

### "Rendering failed" errors

- Check that SVG files are valid
- Some SVG features may not be fully supported yet
- Review the error message in the report for details

### Diff tool not working

- Verify the diff tool path is correct
- Ensure the tool is installed and in PATH
- The test will continue even if diff generation fails

### Low similarity scores

- This is expected for features not yet implemented
- Use diff images to understand what's different
- Focus on improving high-priority features first

## Integration with CI/CD

The reftest command can be integrated into CI/CD pipelines:

```bash
# Run tests and check average similarity
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir ci-results

# Parse report.json to extract metrics
# Set thresholds for CI pass/fail if needed
```

Note: Since this is a scoring system, you may want to:

- Track similarity scores over time
- Set minimum thresholds for specific test categories
- Generate trend reports from multiple runs

## Running

```bash
cargo run -p grida-dev -- reftest \
  --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
  --output-dir test-results
```

> Important
>
> - The diff comparer composites images over a solid background before pixel diffing.
> - Default background is `black` (equivalent to `--bg black`). For most SVG test suites where text is black, running with a white background improves text-edge sensitivity and reduces false negatives.
> - Recommendation: use `--bg white` for SVG tests unless a specific test suite requires another color.
>
> Example:
>
> ```bash
> cargo run -p grida-dev -- reftest \
>   --suite-dir fixtures/local/W3C_SVG_11_TestSuite \
>   --output-dir test-results \
>   --threshold 0 \
>   --bg white
> ```
