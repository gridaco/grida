# Supabase / Database (contributors)

This folder contains our Supabase project configuration and database migrations.

- **Migrations**: `./migrations/*` (source of truth for schema changes)
- **Declarative schemas (reference only)**: `./schemas/*` (not guaranteed fully synced; see `schemas/README.md`)

---

## Local development (safe by default)

Local development uses **Supabase CLI + Docker** and runs a fully local stack (Postgres, Auth, Storage, Studio, etc.) on `127.0.0.1`.

```txt

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ”§ Development Tools                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Studio  â”‚ http://127.0.0.1:54323     â”‚
â”‚ Mailpit â”‚ http://127.0.0.1:54324     â”‚
â”‚ MCP     â”‚ http://127.0.0.1:54321/mcp â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸŒ APIs                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Project URL    â”‚ http://127.0.0.1:54321              â”‚
â”‚ REST           â”‚ http://127.0.0.1:54321/rest/v1      â”‚
â”‚ GraphQL        â”‚ http://127.0.0.1:54321/graphql/v1   â”‚
â”‚ Edge Functions â”‚ http://127.0.0.1:54321/functions/v1 â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ â› Database                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ URL â”‚ postgresql://postgres:postgres@127.0.0.1:54322/postgres â”‚
â•°â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

```

**Key safety property**

- Running local commands **does not require** a Supabase access token and **does not know about any remote project** unless you explicitly link one.
- If you never run `supabase link`, you can safely â€œabuseâ€ local commands like reset/seed/drop without any chance of touching production.

### Setup

- Install prerequisites:
  - Docker Desktop (running)
  - Supabase CLI (`supabase`)
- From the repo root, work inside `./supabase` (commands below assume `cd supabase`).

### JWT signing keys (one-time local setup)

This repo intentionally does **not** commit `signing_keys.json` (itâ€™s gitignored). You may need to generate it once for local setup.

```bash
cd supabase
touch signing_keys.json
supabase gen signing-key --append
```

### Day-to-day commands (local only)

Start / stop / inspect local stack:

```bash
supabase start
supabase status
supabase stop
```

Reset local database (drop + re-apply migrations + seed):

```bash
supabase db reset
```

Create a new migration:

```bash
supabase migration new <name>
```

Apply migrations locally (when you donâ€™t want a full reset):

```bash
supabase migration up
```

### Supabase Types

[`database/database-generated.types.ts`](../database/database-generated.types.ts) is generated by running the following command:

```bash
# cwd //

supabase gen types typescript --local \
  --schema public \
  --schema grida_ciam_public \
  --schema grida_library \
  --schema grida_www \
  --schema grida_g11n \
  --schema grida_x_supabase \
  --schema grida_sites \
  --schema grida_canvas \
  --schema grida_commerce \
  --schema grida_forms_secure \
  --schema grida_forms \
  --schema grida_storage \
  --schema grida_west \
  --schema grida_west_referral \
  > database/database-generated.types.ts

# or with --project-id for hosted db
supabase gen types typescript \
  --project-id $PROJECT_REF \
  ...
```

### Good local workflow

- Make schema changes by writing SQL migrations in `./migrations/`.
- Use `supabase db reset` frequently to ensure a clean, reproducible state.
- Prefer type generation from `--local` while iterating.

### Environment Variables

The editor requires the following Supabase environment variables (set in `editor/.env.local`):

**Required:**

- `NEXT_PUBLIC_SUPABASE_URL` - Your Supabase project URL

**Public key:**

- `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` - The publishable key

**Secret key (new preferred):**

- `SUPABASE_SECRET_KEY` - The secret key for server-side operations (replaces service role key)

After running `supabase start`, you can find these values in the output or by running `supabase status`.

---

## Production (caution)

Everything in this section can affect **remote** environments. Keep this minimal and refer to official docs for details.

**Rules**

- Never run remote commands while â€œtesting something quicklyâ€.
- Never run destructive commands (anything that resets/drops) against remote databases.
- Treat `supabase link` as the point where commands can start targeting a remote project.

### Link the CLI to a remote project (enables remote operations)

```bash
supabase link --project-ref <project-ref>
```

Notes:

- Linking writes local project metadata (and may create/update `.supabase/`), so be mindful of what you commit.
- Remote commands typically require `SUPABASE_ACCESS_TOKEN` (do not commit tokens; use your shell env).

### Deploy migrations to the linked remote database

```bash
supabase db push
```

### Generate types from the linked remote project

```bash
supabase gen types typescript --linked
```

### Official docs

- Local development: `https://supabase.com/docs/guides/local-development`
- CLI reference: `https://supabase.com/docs/reference/cli/introduction`

If youâ€™re unsure, **do not run production commands**â€”stick to the local workflow above.
